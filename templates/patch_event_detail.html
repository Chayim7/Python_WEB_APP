{% extends "base.html" %}

{% block title %}
  {% if is_new %}Create Patch Event{% else %}Patch Event Detail{% endif %}
{% endblock %}

{% block content %}
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-semibold text-base-content">
      {% if is_new %}Create Patch Event{% else %}Patch Event Detail{% endif %}
    </h1>
    <a href="/" class="btn btn-ghost">Back to Dashboard</a>
  </div>

  {% if message %}
    <div class="alert alert-info shadow mb-4">
      <span>{{ message }}</span>
    </div>
  {% endif %}

  <div class="grid gap-6 md:grid-cols-2">
    <div class="card bg-base-200 border border-base-300/60 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Patch Metadata</h2>

        {% if is_new %}
          <form method="post" action="/patch-events" class="space-y-4">
            <div>
              <label class="label"><span class="label-text">Service</span></label>
              <select
                name="service_id"
                class="select select-bordered w-full"
                required
              >
                <option value="" disabled selected>Select a service</option>
                {% for svc in services %}
                  <option value="{{ svc.id }}">{{ svc.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="label"><span class="label-text">Environment</span></label>
              <select
                name="environment"
                class="select select-bordered w-full"
                required
              >
                <option value="" disabled selected>Select environment</option>
                {% for env in environment_options %}
                  <option value="{{ env }}">{{ env }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="label"><span class="label-text">AMI ID</span></label>
              <input
                type="text"
                name="ami_id"
                class="input input-bordered w-full font-mono text-sm"
                placeholder="ami-0syntheticabcd"
                required
              />
            </div>

            <div>
              <label class="label"><span class="label-text">Patch Date</span></label>
              <input
                type="date"
                name="patch_date"
                class="input input-bordered w-full"
                required
              />
            </div>

            <div>
              <label class="label"><span class="label-text">Notes</span></label>
              <textarea
                name="notes"
                class="textarea textarea-bordered w-full"
                rows="3"
                placeholder="Optional description of this synthetic patch event"
              ></textarea>
            </div>

            <div class="pt-2">
              <button type="submit" class="btn btn-primary">Create Patch Event</button>
            </div>
          </form>
        {% else %}
          <div class="space-y-3">
            <div>
              <span class="label-text font-semibold">Service</span>
              <div>{{ patch_event.service.name }}</div>
            </div>
            <div>
              <span class="label-text font-semibold">Environment</span>
              <div>{{ patch_event.environment.value }}</div>
            </div>
            <div>
              <span class="label-text font-semibold">AMI ID</span>
              <div class="font-mono text-sm">{{ patch_event.ami_id }}</div>
            </div>
            <div>
              <span class="label-text font-semibold">Patch Date</span>
              <div>{{ patch_event.patch_date }}</div>
            </div>
            <div>
              <span class="label-text font-semibold">Notes</span>
              <div>{{ patch_event.notes or "(none)" }}</div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    {% if not is_new and patch_event %}
      <div class="space-y-6">
        <div class="card bg-base-200 border border-base-300/60 shadow-xl">
          <div class="card-body space-y-3">
            <h2 class="card-title">Lifecycle State</h2>
            <p class="mb-2 text-sm text-base-content/80">
              Current state:
              <span
                class="badge badge-sm
                  {% if patch_event.current_state_code.startswith('DEV') %} badge-info
                  {% elif patch_event.current_state_code.startswith('STAGE') %} badge-warning
                  {% elif patch_event.current_state_code.startswith('PROD') %} badge-success
                  {% elif patch_event.current_state_code == 'CLOSED' %} badge-neutral
                  {% else %} badge-outline{% endif %}"
              >
                {{ patch_event.current_state_code }}
              </span>
            </p>

            <form
              method="post"
              action="/patch-events/{{ patch_event.id }}/transition-state"
              class="flex flex-col sm:flex-row gap-2 items-start sm:items-end"
            >
              <div class="w-full sm:w-auto">
                <label class="label">
                  <span class="label-text">Next state</span>
                </label>
                <select
                  name="target_state"
                  class="select select-bordered w-full min-w-[12rem]"
                  {% if not allowed_next_states %}disabled{% endif %}
                >
                  {% if not allowed_next_states %}
                    <option value="">No further transitions allowed</option>
                  {% else %}
                    {% for st in allowed_next_states %}
                      <option value="{{ st }}">{{ st }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>

              <button
                type="submit"
                class="btn btn-secondary mt-2 sm:mt-6"
                {% if not allowed_next_states %}disabled{% endif %}
              >
                Apply transition
              </button>
            </form>

            <p class="text-xs text-base-content/60">
              Transitions are restricted by the lifecycle rules: DEV evidence
              is required before promoting toward STAGE/PROD, and the event
              cannot be closed unless PROD is patched.
            </p>
          </div>
        </div>

        <div class="card bg-base-200 border border-base-300/60 shadow-xl">
          <div class="card-body space-y-4">
            <h2 class="card-title">Synthetic Scan Evidence</h2>

            <div class="flex flex-wrap gap-4 text-sm">
              <div>
                <span class="font-semibold">BEFORE snapshot:</span>
                <span>{{ before_count }} vulnerabilities</span>
              </div>
              <div>
                <span class="font-semibold">AFTER snapshot:</span>
                <span>{{ after_count }} vulnerabilities</span>
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <form
                method="post"
                action="/patch-events/{{ patch_event.id }}/generate-before"
              >
                <button type="submit" class="btn btn-sm btn-outline">
                  Generate BEFORE (synthetic)
                </button>
              </form>

              <form
                method="post"
                action="/patch-events/{{ patch_event.id }}/generate-after"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-outline"
                  {% if before_count == 0 %}disabled{% endif %}
                >
                  Generate AFTER (synthetic)
                </button>
              </form>

              <form
                method="post"
                action="/patch-events/{{ patch_event.id }}/compute-evidence"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-primary"
                  {% if before_count == 0 or after_count == 0 %}disabled{% endif %}
                >
                  Compute fixed vulnerabilities
                </button>
              </form>
            </div>

            {% if before_count == 0 %}
              <p class="text-xs text-warning mt-2">
                Generate BEFORE snapshot first to unlock AFTER.
              </p>
            {% endif %}

            {% if before_count == 0 or after_count == 0 %}
              <p class="text-xs text-warning mt-1">
                Compute fixed vulnerabilities requires BOTH BEFORE and AFTER snapshots.
              </p>
            {% endif %}

            {% if dev_evidence_available and fixed_vulnerabilities %}
              <div class="divider text-sm">Fixed vulnerabilities</div>

              {% set crit = severity_counts.CRITICAL or 0 %}
              {% set high = severity_counts.HIGH or 0 %}
              {% set med = severity_counts.MEDIUM or 0 %}
              {% set low = severity_counts.LOW or 0 %}
              {% set total = crit + high + med + low %}

              <div class="space-y-4 mb-4">
                <div class="flex flex-wrap items-center gap-2 text-sm">
                  <span class="font-semibold text-slate-100">
                    Counts by severity:
                  </span>
                  <span class="badge badge-sm badge-error">CRIT: {{ crit }}</span>
                  <span class="badge badge-sm badge-warning">HIGH: {{ high }}</span>
                  <span class="badge badge-sm badge-info">MED: {{ med }}</span>
                  <span class="badge badge-sm badge-success">LOW: {{ low }}</span>
                </div>

                <div class="space-y-2 text-xs text-slate-300">
                  <div>
                    <div class="flex justify-between mb-1">
                      <span class="font-semibold text-error">Critical</span>
                      <span>
                        {{ crit }}
                        {% if total %}
                          ({{ (crit * 100 // total) }}%)
                        {% endif %}
                      </span>
                    </div>
                    <progress
                      class="progress progress-error h-2"
                      value="{{ crit }}"
                      max="{{ total or 1 }}"
                    ></progress>
                  </div>

                  <div>
                    <div class="flex justify-between mb-1">
                      <span class="font-semibold text-warning">High</span>
                      <span>
                        {{ high }}
                        {% if total %}
                          ({{ (high * 100 // total) }}%)
                        {% endif %}
                      </span>
                    </div>
                    <progress
                      class="progress progress-warning h-2"
                      value="{{ high }}"
                      max="{{ total or 1 }}"
                    ></progress>
                  </div>

                  <div>
                    <div class="flex justify-between mb-1">
                      <span class="font-semibold text-info">Medium</span>
                      <span>
                        {{ med }}
                        {% if total %}
                          ({{ (med * 100 // total) }}%)
                        {% endif %}
                      </span>
                    </div>
                    <progress
                      class="progress progress-info h-2"
                      value="{{ med }}"
                      max="{{ total or 1 }}"
                    ></progress>
                  </div>

                  <div>
                    <div class="flex justify-between mb-1">
                      <span class="font-semibold text-success">Low</span>
                      <span>
                        {{ low }}
                        {% if total %}
                          ({{ (low * 100 // total) }}%)
                        {% endif %}
                      </span>
                    </div>
                    <progress
                      class="progress progress-success h-2"
                      value="{{ low }}"
                      max="{{ total or 1 }}"
                    ></progress>
                  </div>
                </div>
              </div>

              <div class="overflow-x-auto max-h-80">
                <table class="table table-zebra table-sm w-full">
                  <thead class="bg-neutral-900/80 text-[0.7rem] uppercase tracking-wide text-slate-400">
                    <tr>
                      <th>Identifier</th>
                      <th>CVE</th>
                      <th>Plugin ID</th>
                      <th>Severity</th>
                      <th>Host</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-neutral-800">
                    {% for v in fixed_vulnerabilities %}
                      <tr>
                        <td class="font-mono text-xs">{{ v.synthetic_id }}</td>
                        <td class="font-mono text-xs">{{ v.cve or "-" }}</td>
                        <td class="font-mono text-xs">{{ v.plugin_id or "-" }}</td>
                        <td>{{ v.severity.value }}</td>
                        <td class="font-mono text-xs">{{ v.host }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% elif dev_evidence_available %}
              <p class="text-sm text-base-content/70">
                DEV evidence is marked available, but no fixed vulnerabilities
                are currently derived from the synthetic snapshots.
              </p>
            {% else %}
              <p class="text-sm text-base-content/70">
                Generate synthetic BEFORE and AFTER snapshots, then compute
                fixed vulnerabilities to populate DEV evidence for this event.
              </p>
            {% endif %}
          </div>
        </div>

        <div class="card bg-base-200 border border-base-300/60 shadow-xl">
          <div class="card-body space-y-4">
            <h2 class="card-title">Change Request Summaries (Synthetic)</h2>

            <div class="flex flex-wrap gap-2 mb-2">
              <form
                method="post"
                action="/patch-events/{{ patch_event.id }}/generate-stage-cr"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-outline"
                  {% if not dev_evidence_available %}disabled{% endif %}
                >
                  Generate STAGE CR Summary
                </button>
              </form>

              <form
                method="post"
                action="/patch-events/{{ patch_event.id }}/generate-prod-cr"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-outline"
                  {% if not prod_cr_allowed %}disabled{% endif %}
                >
                  Generate PROD CR Summary
                </button>
              </form>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <p class="text-xs font-semibold mb-1">STAGE CR Summary</p>
                <textarea
                  readonly
                  class="textarea textarea-bordered w-full h-48 text-xs font-mono"
                  placeholder="Generate STAGE CR summary to see text here."
                >{{ stage_cr_summary or "" }}</textarea>
              </div>

              <div>
                <p class="text-xs font-semibold mb-1">PROD CR Summary</p>
                <textarea
                  readonly
                  class="textarea textarea-bordered w-full h-48 text-xs font-mono"
                  placeholder="Generate PROD CR summary (once allowed) to see text here."
                >{{ prod_cr_summary or "" }}</textarea>
              </div>
            </div>

            <p class="text-[0.7rem] text-base-content/60">
              These summaries are generated from synthetic, non-production data
              and are intended only as copy/paste examples for a conceptual
              change management system. They do not interact with ServiceNow or
              any real ticketing tool.
            </p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
