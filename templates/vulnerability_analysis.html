{% extends "base.html" %}

{% block title %}Vulnerability Analysis - {{ patch_event.service.name }}{% endblock %}

{% block content %}
<!-- Tippy.js for tooltips -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>

<style>
  /* 3D Card Effects */
  .card-3d {
    transform-style: preserve-3d;
    transition: transform 0.4s ease, box-shadow 0.4s ease;
    background: linear-gradient(145deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 30, 0.95));
    border: 1px solid rgba(99, 102, 241, 0.2);
    backdrop-filter: blur(10px);
  }
  .card-3d:hover {
    transform: translateY(-8px) rotateX(2deg);
    box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
  }

  /* Glassmorphism */
  .glass {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Animated gradient background */
  .gradient-bg {
    background: linear-gradient(-45deg, #1e1e2e, #2d1b4e, #1e3a5f, #1e1e2e);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Pulse animation for stats */
  .stat-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Floating animation */
  .float {
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  /* Severity colors */
  .severity-critical { color: #ef4444; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
  .severity-high { color: #f97316; background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3); }
  .severity-medium { color: #eab308; background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); }
  .severity-low { color: #22c55e; background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); }

  /* Chart container with 3D perspective */
  .chart-container {
    perspective: 1000px;
    transform-style: preserve-3d;
  }
  .chart-inner {
    transition: transform 0.5s ease;
  }
  .chart-container:hover .chart-inner {
    transform: rotateY(5deg) rotateX(5deg);
  }

  /* Glow effects */
  .glow-primary {
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.3), 0 0 40px rgba(99, 102, 241, 0.1);
  }
  .glow-success {
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), 0 0 40px rgba(34, 197, 94, 0.1);
  }

  /* Table row hover effect */
  .vuln-row {
    transition: all 0.3s ease;
  }
  .vuln-row:hover {
    transform: scale(1.01);
    background: rgba(99, 102, 241, 0.1) !important;
  }

  /* Progress bar animation */
  .progress-animated {
    animation: progressGrow 1.5s ease-out forwards;
  }
  @keyframes progressGrow {
    from { width: 0%; }
  }

  /* Tab styling */
  .tab-3d {
    transition: all 0.3s ease;
  }
  .tab-3d:hover {
    transform: translateY(-2px);
  }
  .tab-3d.tab-active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
    border-bottom: 2px solid #6366f1;
  }

  /* Animated counter */
  .counter-animate {
    display: inline-block;
    transition: transform 0.3s ease;
  }
  .counter-animate.counting {
    transform: scale(1.1);
  }

  /* Search input styling */
  .search-input {
    background: rgba(30, 30, 40, 0.8);
    border: 1px solid rgba(99, 102, 241, 0.3);
    transition: all 0.3s ease;
  }
  .search-input:focus {
    border-color: #6366f1;
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    outline: none;
  }

  /* Sortable header */
  .sortable {
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
  }
  .sortable:hover {
    color: #6366f1;
  }
  .sortable::after {
    content: '‚áÖ';
    margin-left: 4px;
    opacity: 0.4;
  }
  .sortable.asc::after {
    content: '‚Üë';
    opacity: 1;
    color: #22c55e;
  }
  .sortable.desc::after {
    content: '‚Üì';
    opacity: 1;
    color: #ef4444;
  }

  /* Chart type switcher */
  .chart-switcher {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: rgba(30, 30, 40, 0.8);
    border-radius: 8px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }
  .chart-switcher button {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    background: transparent;
    color: #94a3b8;
    border: none;
    cursor: pointer;
  }
  .chart-switcher button:hover {
    background: rgba(99, 102, 241, 0.2);
  }
  .chart-switcher button.active {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
  }

  /* Keyboard shortcut badge */
  .kbd-hint {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: rgba(30, 30, 40, 0.9);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 4px;
    font-size: 0.65rem;
    color: #94a3b8;
    font-family: monospace;
  }

  /* Toast notification */
  .toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 1000;
  }
  .toast-notification.show {
    transform: translateY(0);
    opacity: 1;
  }

  /* Row highlight on filter */
  .highlight-row {
    animation: highlightPulse 0.5s ease;
  }
  @keyframes highlightPulse {
    0%, 100% { background: transparent; }
    50% { background: rgba(99, 102, 241, 0.3); }
  }

  /* Severity filter buttons */
  .severity-filter {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }
  .severity-filter:hover {
    transform: scale(1.05);
  }
  .severity-filter.active {
    border-color: white;
    box-shadow: 0 0 10px currentColor;
  }

  /* Export dropdown */
  .export-dropdown {
    position: relative;
  }
  .export-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: rgba(30, 30, 40, 0.95);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 160px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 100;
  }
  .export-dropdown:hover .export-menu,
  .export-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  .export-menu button {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 8px 16px;
    background: transparent;
    border: none;
    color: #e2e8f0;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .export-menu button:hover {
    background: rgba(99, 102, 241, 0.2);
  }

  /* Loading spinner */
  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(99, 102, 241, 0.3);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Particle effect container */
  .particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
  }
  .particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: #6366f1;
    border-radius: 50%;
    animation: particleFloat 3s ease-in-out infinite;
  }
  @keyframes particleFloat {
    0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
    50% { transform: translateY(-20px) scale(1.5); opacity: 1; }
  }
</style>

<!-- Toast Notification -->
<div id="toast" class="toast-notification">
  <span id="toastMessage">Action completed!</span>
</div>

<!-- Keyboard Shortcuts Modal -->
<dialog id="shortcutsModal" class="modal">
  <div class="modal-box bg-neutral-900 border border-neutral-700">
    <h3 class="font-bold text-lg mb-4">‚å®Ô∏è Keyboard Shortcuts</h3>
    <div class="space-y-2 text-sm">
      <div class="flex justify-between"><span>Search vulnerabilities</span><span class="kbd-hint">/</span></div>
      <div class="flex justify-between"><span>Generate report</span><span class="kbd-hint">R</span></div>
      <div class="flex justify-between"><span>Export CSV</span><span class="kbd-hint">E</span></div>
      <div class="flex justify-between"><span>Tab: Fixed</span><span class="kbd-hint">1</span></div>
      <div class="flex justify-between"><span>Tab: Remaining</span><span class="kbd-hint">2</span></div>
      <div class="flex justify-between"><span>Tab: Before</span><span class="kbd-hint">3</span></div>
      <div class="flex justify-between"><span>Tab: After</span><span class="kbd-hint">4</span></div>
      <div class="flex justify-between"><span>Toggle theme</span><span class="kbd-hint">T</span></div>
      <div class="flex justify-between"><span>Show shortcuts</span><span class="kbd-hint">?</span></div>
      <div class="flex justify-between"><span>Close modal</span><span class="kbd-hint">Esc</span></div>
    </div>
    <div class="modal-action">
      <form method="dialog"><button class="btn">Close</button></form>
    </div>
  </div>
</dialog>

<!-- Header with back navigation -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
  <div>
    <a href="/patch-events/{{ patch_event.id }}" class="btn btn-ghost btn-sm gap-2 mb-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Patch Event
    </a>
    <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-purple-400 bg-clip-text text-transparent">
      Vulnerability Analysis
    </h1>
    <p class="text-slate-400 mt-1">
      {{ patch_event.service.name }} ¬∑ {{ patch_event.ami_id }} ¬∑ {{ patch_event.patch_date }}
      <button onclick="document.getElementById('shortcutsModal').showModal()" class="kbd-hint ml-2" title="Keyboard shortcuts">
        ? shortcuts
      </button>
    </p>
  </div>
  <div class="flex gap-2 flex-wrap">
    <!-- Export Dropdown -->
    <div class="export-dropdown">
      <button class="btn btn-outline btn-sm gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export
      </button>
      <div class="export-menu">
        <button onclick="exportCSV('fixed')">üìÑ Fixed Vulns (CSV)</button>
        <button onclick="exportCSV('remaining')">üìÑ Remaining (CSV)</button>
        <button onclick="exportCSV('all')">üìÑ All Data (CSV)</button>
        <button onclick="exportJSON()">üìã JSON Export</button>
      </div>
    </div>
    
    <button onclick="generateReport()" class="btn btn-primary gap-2 glow-primary">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      Generate Report
    </button>
  </div>
</div>

<!-- Summary Stats Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
  <div class="card-3d rounded-xl p-5 float relative overflow-hidden" style="animation-delay: 0s;">
    <div class="particles" id="particles-1"></div>
    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Before Patching</div>
    <div class="text-4xl font-bold text-blue-400 counter-animate" data-target="{{ before_count }}">0</div>
    <div class="text-xs text-slate-500 mt-1">Total vulnerabilities</div>
  </div>
  <div class="card-3d rounded-xl p-5 float relative overflow-hidden" style="animation-delay: 0.2s;">
    <div class="particles" id="particles-2"></div>
    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">After Patching</div>
    <div class="text-4xl font-bold text-purple-400 counter-animate" data-target="{{ after_count }}">0</div>
    <div class="text-xs text-slate-500 mt-1">Total vulnerabilities</div>
  </div>
  <div class="card-3d rounded-xl p-5 glow-success float relative overflow-hidden" style="animation-delay: 0.4s;">
    <div class="particles" id="particles-3"></div>
    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Fixed</div>
    <div class="text-4xl font-bold text-green-400 counter-animate" data-target="{{ fixed_count }}">0</div>
    <div class="text-xs text-slate-500 mt-1">Vulnerabilities resolved</div>
  </div>
  <div class="card-3d rounded-xl p-5 float relative overflow-hidden" style="animation-delay: 0.6s;">
    <div class="particles" id="particles-4"></div>
    <div class="text-xs uppercase tracking-wider text-slate-400 mb-1">Remaining</div>
    <div class="text-4xl font-bold text-amber-400 counter-animate" data-target="{{ remaining_count }}">0</div>
    <div class="text-xs text-slate-500 mt-1">Still present</div>
  </div>
</div>

<!-- Effectiveness Score -->
<div class="card-3d rounded-xl p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold">Patch Effectiveness</h2>
    <span class="text-3xl font-bold text-green-400">{{ effectiveness_pct }}%</span>
  </div>
  <div class="w-full bg-neutral-800 rounded-full h-4 overflow-hidden">
    <div class="h-full rounded-full bg-gradient-to-r from-green-500 to-emerald-400 progress-animated" 
         style="width: {{ effectiveness_pct }}%;"></div>
  </div>
  <p class="text-xs text-slate-500 mt-2">
    {{ fixed_count }} of {{ before_count }} vulnerabilities were remediated by this patch
  </p>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Severity Distribution Chart -->
  <div class="card-3d rounded-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Severity Distribution</h2>
      <div class="chart-switcher">
        <button class="active" onclick="switchChart('severity', 'radar', this)">Radar</button>
        <button onclick="switchChart('severity', 'polarArea', this)">Polar</button>
        <button onclick="switchChart('severity', 'bar', this)">Bar</button>
      </div>
    </div>
    <div class="chart-container">
      <div class="chart-inner">
        <canvas id="severityChart" height="280"></canvas>
      </div>
    </div>
  </div>

  <!-- Before vs After Comparison -->
  <div class="card-3d rounded-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Before vs After Comparison</h2>
      <div class="chart-switcher">
        <button class="active" onclick="switchChart('comparison', 'bar', this)">Bar</button>
        <button onclick="switchChart('comparison', 'line', this)">Line</button>
        <button onclick="switchChart('comparison', 'radar', this)">Radar</button>
      </div>
    </div>
    <div class="chart-container">
      <div class="chart-inner">
        <canvas id="comparisonChart" height="280"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Donut Chart for Fixed vs Remaining -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="card-3d rounded-xl p-6">
    <h2 class="text-lg font-semibold mb-4">Remediation Status</h2>
    <div class="chart-container">
      <div class="chart-inner">
        <canvas id="remediationChart" height="280"></canvas>
      </div>
    </div>
  </div>

  <!-- Severity Breakdown Cards -->
  <div class="card-3d rounded-xl p-6">
    <h2 class="text-lg font-semibold mb-4">Fixed by Severity</h2>
    <div class="space-y-4">
      {% for sev, count in fixed_severity_counts.items() %}
      <div class="flex items-center gap-4">
        <div class="w-24 text-sm font-medium 
          {% if sev.value == 'CRITICAL' %}text-red-400
          {% elif sev.value == 'HIGH' %}text-orange-400
          {% elif sev.value == 'MEDIUM' %}text-yellow-400
          {% else %}text-green-400{% endif %}">
          {{ sev.value }}
        </div>
        <div class="flex-1 bg-neutral-800 rounded-full h-3 overflow-hidden">
          <div class="h-full rounded-full progress-animated
            {% if sev.value == 'CRITICAL' %}bg-red-500
            {% elif sev.value == 'HIGH' %}bg-orange-500
            {% elif sev.value == 'MEDIUM' %}bg-yellow-500
            {% else %}bg-green-500{% endif %}"
            style="width: {{ (count / fixed_count * 100) if fixed_count > 0 else 0 }}%;"></div>
        </div>
        <div class="w-12 text-right font-mono text-sm">{{ count }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Tabbed Vulnerability Tables -->
<div class="card-3d rounded-xl overflow-hidden mb-8">
  <!-- Tab Headers -->
  <div class="tabs tabs-boxed bg-transparent p-2 border-b border-neutral-800">
    <button class="tab tab-3d tab-active" data-tab="fixed" onclick="showTab('fixed', this)">
      <span class="mr-2">‚úÖ</span> Fixed (<span id="fixed-count">{{ fixed_count }}</span>)
    </button>
    <button class="tab tab-3d" data-tab="remaining" onclick="showTab('remaining', this)">
      <span class="mr-2">‚ö†Ô∏è</span> Remaining (<span id="remaining-count">{{ remaining_count }}</span>)
    </button>
    <button class="tab tab-3d" data-tab="before" onclick="showTab('before', this)">
      <span class="mr-2">üìã</span> Before (<span id="before-count">{{ before_count }}</span>)
    </button>
    <button class="tab tab-3d" data-tab="after" onclick="showTab('after', this)">
      <span class="mr-2">üìã</span> After (<span id="after-count">{{ after_count }}</span>)
    </button>
  </div>

  <!-- Search and Filter Bar -->
  <div class="p-4 border-b border-neutral-800 bg-neutral-900/50">
    <div class="flex flex-wrap items-center gap-4">
      <!-- Search Input -->
      <div class="relative flex-1 min-w-[200px]">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Search CVE, Plugin ID, Host, Description... (Press /)" 
          class="search-input w-full px-4 py-2 pl-10 rounded-lg text-sm"
          oninput="filterTable()"
        />
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      
      <!-- Severity Filters -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500">Filter:</span>
        <button class="severity-filter bg-red-500/20 text-red-400 active" data-severity="all" onclick="filterBySeverity('all', this)">All</button>
        <button class="severity-filter bg-red-500/20 text-red-400" data-severity="CRITICAL" onclick="filterBySeverity('CRITICAL', this)">Critical</button>
        <button class="severity-filter bg-orange-500/20 text-orange-400" data-severity="HIGH" onclick="filterBySeverity('HIGH', this)">High</button>
        <button class="severity-filter bg-yellow-500/20 text-yellow-400" data-severity="MEDIUM" onclick="filterBySeverity('MEDIUM', this)">Medium</button>
        <button class="severity-filter bg-green-500/20 text-green-400" data-severity="LOW" onclick="filterBySeverity('LOW', this)">Low</button>
      </div>

      <!-- Results count -->
      <div class="text-xs text-slate-500">
        Showing <span id="visibleCount" class="text-primary font-semibold">0</span> results
      </div>
    </div>
  </div>

  <!-- Fixed Vulnerabilities Table -->
  <div id="tab-fixed" class="tab-content p-4">
    {% if fixed_vulnerabilities %}
    <div class="overflow-x-auto max-h-96">
      <table class="table table-sm w-full vuln-table" data-tab="fixed">
        <thead class="bg-neutral-900/80 text-[0.7rem] uppercase tracking-wide text-slate-400 sticky top-0">
          <tr>
            <th class="sortable" data-col="0" onclick="sortTable(this, 0)">CVE ID</th>
            <th class="sortable" data-col="1" onclick="sortTable(this, 1)">Plugin ID</th>
            <th class="sortable" data-col="2" onclick="sortTable(this, 2)">Severity</th>
            <th class="sortable" data-col="3" onclick="sortTable(this, 3)">Host</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln in fixed_vulnerabilities %}
          <tr class="vuln-row border-b border-neutral-800">
            <td class="font-mono text-xs text-blue-400">{{ vuln.cve_id or 'N/A' }}</td>
            <td class="font-mono text-xs">{{ vuln.plugin_id }}</td>
            <td>
              <span class="badge badge-sm 
                {% if vuln.severity.value == 'CRITICAL' %}badge-error
                {% elif vuln.severity.value == 'HIGH' %}badge-warning
                {% elif vuln.severity.value == 'MEDIUM' %}badge-info
                {% else %}badge-success{% endif %}">
                {{ vuln.severity.value }}
              </span>
            </td>
            <td class="font-mono text-xs">{{ vuln.host }}</td>
            <td class="text-xs text-slate-400 max-w-xs truncate">{{ vuln.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-slate-500 text-center py-8">No fixed vulnerabilities found.</p>
    {% endif %}
  </div>

  <!-- Remaining Vulnerabilities Table -->
  <div id="tab-remaining" class="tab-content p-4 hidden">
    {% if remaining_vulnerabilities %}
    <div class="overflow-x-auto max-h-96">
      <table class="table table-sm w-full vuln-table" data-tab="remaining">
        <thead class="bg-neutral-900/80 text-[0.7rem] uppercase tracking-wide text-slate-400 sticky top-0">
          <tr>
            <th class="sortable" data-col="0" onclick="sortTable(this, 0)">CVE ID</th>
            <th class="sortable" data-col="1" onclick="sortTable(this, 1)">Plugin ID</th>
            <th class="sortable" data-col="2" onclick="sortTable(this, 2)">Severity</th>
            <th class="sortable" data-col="3" onclick="sortTable(this, 3)">Host</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln in remaining_vulnerabilities %}
          <tr class="vuln-row border-b border-neutral-800">
            <td class="font-mono text-xs text-blue-400">{{ vuln.cve_id or 'N/A' }}</td>
            <td class="font-mono text-xs">{{ vuln.plugin_id }}</td>
            <td>
              <span class="badge badge-sm 
                {% if vuln.severity.value == 'CRITICAL' %}badge-error
                {% elif vuln.severity.value == 'HIGH' %}badge-warning
                {% elif vuln.severity.value == 'MEDIUM' %}badge-info
                {% else %}badge-success{% endif %}">
                {{ vuln.severity.value }}
              </span>
            </td>
            <td class="font-mono text-xs">{{ vuln.host }}</td>
            <td class="text-xs text-slate-400 max-w-xs truncate">{{ vuln.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-slate-500 text-center py-8">No remaining vulnerabilities - all issues resolved! üéâ</p>
    {% endif %}
  </div>

  <!-- Before Snapshot Table -->
  <div id="tab-before" class="tab-content p-4 hidden">
    {% if before_vulnerabilities %}
    <div class="overflow-x-auto max-h-96">
      <table class="table table-sm w-full vuln-table" data-tab="before">
        <thead class="bg-neutral-900/80 text-[0.7rem] uppercase tracking-wide text-slate-400 sticky top-0">
          <tr>
            <th class="sortable" data-col="0" onclick="sortTable(this, 0)">CVE ID</th>
            <th class="sortable" data-col="1" onclick="sortTable(this, 1)">Plugin ID</th>
            <th class="sortable" data-col="2" onclick="sortTable(this, 2)">Severity</th>
            <th class="sortable" data-col="3" onclick="sortTable(this, 3)">Host</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln in before_vulnerabilities %}
          <tr class="vuln-row border-b border-neutral-800">
            <td class="font-mono text-xs text-blue-400">{{ vuln.cve_id or 'N/A' }}</td>
            <td class="font-mono text-xs">{{ vuln.plugin_id }}</td>
            <td>
              <span class="badge badge-sm 
                {% if vuln.severity.value == 'CRITICAL' %}badge-error
                {% elif vuln.severity.value == 'HIGH' %}badge-warning
                {% elif vuln.severity.value == 'MEDIUM' %}badge-info
                {% else %}badge-success{% endif %}">
                {{ vuln.severity.value }}
              </span>
            </td>
            <td class="font-mono text-xs">{{ vuln.host }}</td>
            <td class="text-xs text-slate-400 max-w-xs truncate">{{ vuln.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-slate-500 text-center py-8">No BEFORE snapshot data available.</p>
    {% endif %}
  </div>

  <!-- After Snapshot Table -->
  <div id="tab-after" class="tab-content p-4 hidden">
    {% if after_vulnerabilities %}
    <div class="overflow-x-auto max-h-96">
      <table class="table table-sm w-full vuln-table" data-tab="after">
        <thead class="bg-neutral-900/80 text-[0.7rem] uppercase tracking-wide text-slate-400 sticky top-0">
          <tr>
            <th class="sortable" data-col="0" onclick="sortTable(this, 0)">CVE ID</th>
            <th class="sortable" data-col="1" onclick="sortTable(this, 1)">Plugin ID</th>
            <th class="sortable" data-col="2" onclick="sortTable(this, 2)">Severity</th>
            <th class="sortable" data-col="3" onclick="sortTable(this, 3)">Host</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln in after_vulnerabilities %}
          <tr class="vuln-row border-b border-neutral-800">
            <td class="font-mono text-xs text-blue-400">{{ vuln.cve_id or 'N/A' }}</td>
            <td class="font-mono text-xs">{{ vuln.plugin_id }}</td>
            <td>
              <span class="badge badge-sm 
                {% if vuln.severity.value == 'CRITICAL' %}badge-error
                {% elif vuln.severity.value == 'HIGH' %}badge-warning
                {% elif vuln.severity.value == 'MEDIUM' %}badge-info
                {% else %}badge-success{% endif %}">
                {{ vuln.severity.value }}
              </span>
            </td>
            <td class="font-mono text-xs">{{ vuln.host }}</td>
            <td class="text-xs text-slate-400 max-w-xs truncate">{{ vuln.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-slate-500 text-center py-8">No AFTER snapshot data available.</p>
    {% endif %}
  </div>
</div>

<!-- Report Modal -->
<dialog id="reportModal" class="modal">
  <div class="modal-box bg-neutral-900 border border-neutral-700 max-w-4xl">
    <h3 class="font-bold text-xl mb-4 bg-gradient-to-r from-primary to-purple-400 bg-clip-text text-transparent">
      Vulnerability Assessment Report
    </h3>
    <div id="reportContent" class="prose prose-invert max-w-none">
      <!-- Report content will be injected here -->
    </div>
    <div class="modal-action">
      <button onclick="copyReport()" class="btn btn-primary gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        Copy to Clipboard
      </button>
      <button onclick="printReport()" class="btn btn-secondary gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        Print
      </button>
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
</dialog>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // ============================================
  // DATA FROM BACKEND
  // ============================================
  const chartData = {
    before: {
      critical: {{ before_severity.CRITICAL }},
      high: {{ before_severity.HIGH }},
      medium: {{ before_severity.MEDIUM }},
      low: {{ before_severity.LOW }}
    },
    after: {
      critical: {{ after_severity.CRITICAL }},
      high: {{ after_severity.HIGH }},
      medium: {{ after_severity.MEDIUM }},
      low: {{ after_severity.LOW }}
    },
    fixed: {
      critical: {{ fixed_severity.CRITICAL }},
      high: {{ fixed_severity.HIGH }},
      medium: {{ fixed_severity.MEDIUM }},
      low: {{ fixed_severity.LOW }}
    },
    remaining: {
      critical: {{ remaining_severity.CRITICAL }},
      high: {{ remaining_severity.HIGH }},
      medium: {{ remaining_severity.MEDIUM }},
      low: {{ remaining_severity.LOW }}
    },
    totals: {
      before: {{ before_count }},
      after: {{ after_count }},
      fixed: {{ fixed_count }},
      remaining: {{ remaining_count }}
    }
  };

  // State management
  let currentTab = 'fixed';
  let currentSeverityFilter = 'all';
  let charts = {};

  // ============================================
  // TOAST NOTIFICATIONS
  // ============================================
  function showToast(message, duration = 3000) {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
  }

  // ============================================
  // ANIMATED COUNTERS
  // ============================================
  function animateCounters() {
    document.querySelectorAll('.counter-animate').forEach(counter => {
      const target = parseInt(counter.dataset.target);
      const duration = 1500;
      const step = target / (duration / 16);
      let current = 0;
      
      counter.classList.add('counting');
      const timer = setInterval(() => {
        current += step;
        if (current >= target) {
          counter.textContent = target;
          counter.classList.remove('counting');
          clearInterval(timer);
        } else {
          counter.textContent = Math.floor(current);
        }
      }, 16);
    });
  }

  // ============================================
  // PARTICLE EFFECTS
  // ============================================
  function createParticles() {
    for (let i = 1; i <= 4; i++) {
      const container = document.getElementById(`particles-${i}`);
      if (!container) continue;
      for (let j = 0; j < 5; j++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        particle.style.animationDelay = `${Math.random() * 3}s`;
        container.appendChild(particle);
      }
    }
  }

  // ============================================
  // CHART CONFIGURATIONS
  // ============================================
  const chartConfigs = {
    severity: {
      radar: {
        type: 'radar',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [
            { label: 'Before', data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', borderWidth: 2, pointBackgroundColor: '#3b82f6' },
            { label: 'After', data: [chartData.after.critical, chartData.after.high, chartData.after.medium, chartData.after.low], backgroundColor: 'rgba(168, 85, 247, 0.2)', borderColor: '#a855f7', borderWidth: 2, pointBackgroundColor: '#a855f7' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { r: { angleLines: { color: 'rgba(148, 163, 184, 0.2)' }, grid: { color: 'rgba(148, 163, 184, 0.2)' }, pointLabels: { color: '#94a3b8' }, ticks: { display: false } } } }
      },
      polarArea: {
        type: 'polarArea',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [{ data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(34, 197, 94, 0.7)'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { r: { grid: { color: 'rgba(148, 163, 184, 0.2)' }, ticks: { display: false } } } }
      },
      bar: {
        type: 'bar',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [
            { label: 'Before', data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 6 },
            { label: 'After', data: [chartData.after.critical, chartData.after.high, chartData.after.medium, chartData.after.low], backgroundColor: 'rgba(168, 85, 247, 0.7)', borderRadius: 6 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } } } }
      }
    },
    comparison: {
      bar: {
        type: 'bar',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [
            { label: 'Before', data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 6 },
            { label: 'After', data: [chartData.after.critical, chartData.after.high, chartData.after.medium, chartData.after.low], backgroundColor: 'rgba(168, 85, 247, 0.7)', borderRadius: 6 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } } } }
      },
      line: {
        type: 'line',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [
            { label: 'Before', data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 },
            { label: 'After', data: [chartData.after.critical, chartData.after.high, chartData.after.medium, chartData.after.low], borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { x: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } }, y: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } } } }
      },
      radar: {
        type: 'radar',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low'],
          datasets: [
            { label: 'Before', data: [chartData.before.critical, chartData.before.high, chartData.before.medium, chartData.before.low], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', borderWidth: 2 },
            { label: 'After', data: [chartData.after.critical, chartData.after.high, chartData.after.medium, chartData.after.low], backgroundColor: 'rgba(168, 85, 247, 0.2)', borderColor: '#a855f7', borderWidth: 2 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }, scales: { r: { angleLines: { color: 'rgba(148, 163, 184, 0.2)' }, grid: { color: 'rgba(148, 163, 184, 0.2)' }, pointLabels: { color: '#94a3b8' }, ticks: { display: false } } } }
      }
    }
  };

  // ============================================
  // CHART INITIALIZATION & SWITCHING
  // ============================================
  function initCharts() {
    charts.severity = new Chart(document.getElementById('severityChart').getContext('2d'), chartConfigs.severity.radar);
    charts.comparison = new Chart(document.getElementById('comparisonChart').getContext('2d'), chartConfigs.comparison.bar);
    charts.remediation = new Chart(document.getElementById('remediationChart').getContext('2d'), {
      type: 'doughnut',
      data: { labels: ['Fixed', 'Remaining'], datasets: [{ data: [chartData.totals.fixed, chartData.totals.remaining], backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(251, 191, 36, 0.8)'], borderColor: ['#22c55e', '#fbbf24'], borderWidth: 2, hoverOffset: 10 }] },
      options: { responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
    });
  }

  function switchChart(chartName, chartType, btn) {
    const canvas = document.getElementById(chartName === 'severity' ? 'severityChart' : 'comparisonChart');
    charts[chartName].destroy();
    charts[chartName] = new Chart(canvas.getContext('2d'), chartConfigs[chartName][chartType]);
    
    btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    showToast(`Chart switched to ${chartType}`);
  }

  // ============================================
  // TAB SWITCHING
  // ============================================
  function showTab(tabName, btn) {
    currentTab = tabName;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-3d').forEach(el => el.classList.remove('tab-active'));
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    if (btn) btn.classList.add('tab-active');
    filterTable();
  }

  // ============================================
  // SEARCH & FILTER
  // ============================================
  function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const activeTab = document.getElementById('tab-' + currentTab);
    const rows = activeTab.querySelectorAll('tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const severity = row.querySelector('.badge')?.textContent.trim().toUpperCase() || '';
      const matchesSearch = text.includes(searchTerm);
      const matchesSeverity = currentSeverityFilter === 'all' || severity === currentSeverityFilter;
      
      if (matchesSearch && matchesSeverity) {
        row.style.display = '';
        row.classList.add('highlight-row');
        setTimeout(() => row.classList.remove('highlight-row'), 500);
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    document.getElementById('visibleCount').textContent = visibleCount;
  }

  function filterBySeverity(severity, btn) {
    currentSeverityFilter = severity;
    document.querySelectorAll('.severity-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterTable();
    showToast(`Filtered by ${severity === 'all' ? 'All Severities' : severity}`);
  }

  // ============================================
  // SORTABLE TABLES
  // ============================================
  function sortTable(header, colIndex) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isAsc = header.classList.contains('asc');
    
    // Reset all headers in this table
    table.querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
    
    // Sort rows
    const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
    rows.sort((a, b) => {
      let aVal = a.cells[colIndex].textContent.trim();
      let bVal = b.cells[colIndex].textContent.trim();
      
      // Special handling for severity column
      if (colIndex === 2) {
        aVal = severityOrder[aVal] ?? 99;
        bVal = severityOrder[bVal] ?? 99;
        return isAsc ? bVal - aVal : aVal - bVal;
      }
      
      return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
    });
    
    // Update header state
    header.classList.add(isAsc ? 'desc' : 'asc');
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    showToast(`Sorted by ${header.textContent.replace('‚áÖ', '').trim()}`);
  }

  // ============================================
  // EXPORT FUNCTIONS
  // ============================================
  function exportCSV(type) {
    let data = [];
    const headers = ['CVE ID', 'Plugin ID', 'Severity', 'Host', 'Description'];
    
    const tabMap = { fixed: 'tab-fixed', remaining: 'tab-remaining', all: null };
    const tabs = type === 'all' ? ['tab-fixed', 'tab-remaining', 'tab-before', 'tab-after'] : [tabMap[type]];
    
    tabs.forEach(tabId => {
      if (!tabId) return;
      const rows = document.querySelectorAll(`#${tabId} tbody tr`);
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
          data.push([
            cells[0].textContent.trim(),
            cells[1].textContent.trim(),
            cells[2].textContent.trim(),
            cells[3].textContent.trim(),
            cells[4].textContent.trim()
          ]);
        }
      });
    });

    const csv = [headers.join(','), ...data.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
    downloadFile(csv, `vulnerabilities_${type}_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
    showToast(`Exported ${data.length} rows to CSV`);
  }

  function exportJSON() {
    const exportData = {
      metadata: {
        service: '{{ patch_event.service.name }}',
        ami_id: '{{ patch_event.ami_id }}',
        environment: '{{ patch_event.environment.value }}',
        patch_date: '{{ patch_event.patch_date }}',
        exported_at: new Date().toISOString()
      },
      summary: chartData,
      effectiveness_pct: {{ effectiveness_pct }}
    };
    
    downloadFile(JSON.stringify(exportData, null, 2), `vulnerability_analysis_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    showToast('Exported analysis data to JSON');
  }

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ============================================
  // KEYBOARD SHORTCUTS
  // ============================================
  document.addEventListener('keydown', (e) => {
    // Ignore if typing in input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      if (e.key === 'Escape') e.target.blur();
      return;
    }

    switch(e.key) {
      case '/':
        e.preventDefault();
        document.getElementById('searchInput').focus();
        break;
      case 'r':
      case 'R':
        generateReport();
        break;
      case 'e':
      case 'E':
        exportCSV('all');
        break;
      case '1':
        document.querySelector('[data-tab="fixed"]').click();
        break;
      case '2':
        document.querySelector('[data-tab="remaining"]').click();
        break;
      case '3':
        document.querySelector('[data-tab="before"]').click();
        break;
      case '4':
        document.querySelector('[data-tab="after"]').click();
        break;
      case '?':
        document.getElementById('shortcutsModal').showModal();
        break;
      case 'Escape':
        document.querySelectorAll('dialog[open]').forEach(d => d.close());
        break;
    }
  });

  // ============================================
  // REPORT GENERATION
  // ============================================
  function generateReport() {
    const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    
    const reportHTML = `
      <div class="bg-neutral-800 p-6 rounded-lg mb-4">
        <h4 class="text-lg font-semibold text-primary mb-2">AMI Patch Evidence Report</h4>
        <p class="text-sm text-slate-400">Generated: ${reportDate}</p>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-neutral-800/50 p-4 rounded-lg"><p class="text-xs text-slate-500 uppercase">Service</p><p class="font-semibold">{{ patch_event.service.name }}</p></div>
        <div class="bg-neutral-800/50 p-4 rounded-lg"><p class="text-xs text-slate-500 uppercase">AMI ID</p><p class="font-mono">{{ patch_event.ami_id }}</p></div>
        <div class="bg-neutral-800/50 p-4 rounded-lg"><p class="text-xs text-slate-500 uppercase">Environment</p><p>{{ patch_event.environment.value }}</p></div>
        <div class="bg-neutral-800/50 p-4 rounded-lg"><p class="text-xs text-slate-500 uppercase">Patch Date</p><p>{{ patch_event.patch_date }}</p></div>
      </div>
      <h4 class="text-lg font-semibold mb-3">Executive Summary</h4>
      <p class="mb-4">This patch remediated <strong class="text-green-400">${chartData.totals.fixed}</strong> vulnerabilities out of <strong>${chartData.totals.before}</strong> total, achieving <strong class="text-green-400">{{ effectiveness_pct }}%</strong> effectiveness. <strong class="text-amber-400">${chartData.totals.remaining}</strong> vulnerabilities remain.</p>
      <h4 class="text-lg font-semibold mb-3">Vulnerability Score Breakdown</h4>
      <table class="table table-sm w-full mb-6">
        <thead class="bg-neutral-800"><tr><th>Severity</th><th class="text-center">Before</th><th class="text-center">After</th><th class="text-center">Fixed</th><th class="text-center">Remaining</th></tr></thead>
        <tbody>
          <tr class="border-b border-neutral-700"><td><span class="text-red-400 font-semibold">CRITICAL</span></td><td class="text-center">${chartData.before.critical}</td><td class="text-center">${chartData.after.critical}</td><td class="text-center text-green-400">${chartData.fixed.critical}</td><td class="text-center text-amber-400">${chartData.remaining.critical}</td></tr>
          <tr class="border-b border-neutral-700"><td><span class="text-orange-400 font-semibold">HIGH</span></td><td class="text-center">${chartData.before.high}</td><td class="text-center">${chartData.after.high}</td><td class="text-center text-green-400">${chartData.fixed.high}</td><td class="text-center text-amber-400">${chartData.remaining.high}</td></tr>
          <tr class="border-b border-neutral-700"><td><span class="text-yellow-400 font-semibold">MEDIUM</span></td><td class="text-center">${chartData.before.medium}</td><td class="text-center">${chartData.after.medium}</td><td class="text-center text-green-400">${chartData.fixed.medium}</td><td class="text-center text-amber-400">${chartData.remaining.medium}</td></tr>
          <tr><td><span class="text-green-400 font-semibold">LOW</span></td><td class="text-center">${chartData.before.low}</td><td class="text-center">${chartData.after.low}</td><td class="text-center text-green-400">${chartData.fixed.low}</td><td class="text-center text-amber-400">${chartData.remaining.low}</td></tr>
          <tr class="bg-neutral-800 font-semibold"><td>TOTAL</td><td class="text-center">${chartData.totals.before}</td><td class="text-center">${chartData.totals.after}</td><td class="text-center text-green-400">${chartData.totals.fixed}</td><td class="text-center text-amber-400">${chartData.totals.remaining}</td></tr>
        </tbody>
      </table>
      <h4 class="text-lg font-semibold mb-3">Recommendations</h4>
      <ul class="list-disc list-inside space-y-1 text-sm">
        ${chartData.remaining.critical > 0 ? '<li class="text-red-400">Address ' + chartData.remaining.critical + ' CRITICAL vulnerabilities immediately</li>' : ''}
        ${chartData.remaining.high > 0 ? '<li class="text-orange-400">Schedule remediation for ' + chartData.remaining.high + ' HIGH severity issues</li>' : ''}
        ${chartData.remaining.medium > 0 ? '<li class="text-yellow-400">Plan mitigation for ' + chartData.remaining.medium + ' MEDIUM findings</li>' : ''}
        ${chartData.totals.remaining === 0 ? '<li class="text-green-400">All vulnerabilities successfully remediated!</li>' : ''}
      </ul>
    `;
    
    document.getElementById('reportContent').innerHTML = reportHTML;
    document.getElementById('reportModal').showModal();
    showToast('Report generated');
  }

  function copyReport() {
    navigator.clipboard.writeText(document.getElementById('reportContent').innerText).then(() => showToast('Report copied to clipboard!'));
  }

  function printReport() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Vulnerability Report</title><style>body{font-family:Arial,sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:8px}th{background:#f4f4f4}.text-green-400{color:#22c55e}.text-amber-400{color:#fbbf24}.text-red-400{color:#ef4444}.text-orange-400{color:#f97316}.text-yellow-400{color:#eab308}</style></head><body>${document.getElementById('reportContent').innerHTML}</body></html>`);
    printWindow.document.close();
    printWindow.print();
  }

  // ============================================
  // TOOLTIPS (using Tippy.js)
  // ============================================
  function initTooltips() {
    if (typeof tippy !== 'undefined') {
      tippy('.vuln-row', {
        content: 'Click to view details',
        placement: 'left',
        animation: 'scale',
        theme: 'custom'
      });
      tippy('.sortable', {
        content: 'Click to sort',
        placement: 'top',
        animation: 'scale'
      });
    }
  }

  // ============================================
  // INITIALIZATION
  // ============================================
  document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    animateCounters();
    createParticles();
    initTooltips();
    filterTable(); // Initialize visible count
    showToast('Analysis loaded! Press ? for shortcuts', 4000);
  });
</script>
{% endblock %}
